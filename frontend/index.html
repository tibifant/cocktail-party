<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>cocktail party</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="assets/favicon.png">
  <link rel="stylesheet" type="text/css" href="assets/style.css">
</head>

<body>
  <div id="app_container">
    <h2>ğŸ¹ğŸ¸Cocktail PartyğŸ¸ğŸ¹</h2>
    <ul id="list"></ul>
    <button id="add">Add cocktail</button>
    <div class="box">
      <h3 id="title"></h3>
      <p id="author"></p>
      <p id="instructions"></p>
      <button id="update">Update</button>
      <button id="remove">Delete</button>
    </box>
  </div>

  <audio loop id="audio">
    <source src="assets/cocktail-song.mp3" type="audio/mpeg">
  </audio>
<script>
  const server_url = document.location.hostname == 'localhost' || document.location.hostname == '' ? 'http://localhost:61919/' : '/api/';

  function load_url(url, callback, payload, failure_callback) {
    var xmlhttp;

    console.log("Sending request to '" + url + "':");
    
    if (payload != null)
      console.log(payload);

    if (window.XMLHttpRequest)
      xmlhttp = new XMLHttpRequest();
    else
      xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");

    xmlhttp.onreadystatechange = function () {
      if (xmlhttp.readyState == 4) {
        if (xmlhttp.status >= 200 && xmlhttp.status < 300) {
          try {
            let obj = undefined;
            if (xmlhttp.responseText != "")
              obj = JSON.parse(xmlhttp.responseText);
            callback(obj);
          } catch (e) {            
              failure_callback(false);
          }
        } else {
          if (xmlhttp.status == 403) {

          } else {
            failure_callback(false);
          }
        }
      }
    }

    xmlhttp.ontimeout = (e) => {
      failure_callback();
    };

    xmlhttp.timeout = 7500;
    xmlhttp.open("POST", url, true);
    xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

    if (payload != null)
      xmlhttp.send(JSON.stringify(payload));
    else
      xmlhttp.send();
  }

  function load_backend_url(url, callback, payload, failure_callback) {
    load_url(server_url + url, callback, payload, failure_callback);
  }

  function append_element(parent, type, className) {
    const elem = document.createElement(type);
    elem.className = className;
    parent.appendChild(elem);
    return elem;
  }

  ///////////////////////////////////////////////////////////

  let __id = -1;
  
  function on_failure() {
    alert('An Error occured.');
  }

  function on_add(payload) {
    reset_view();
    handle_click(payload.id);
  }

  function handle_add() {
    load_backend_url('add', on_add, { }, on_failure);
  }

  function handle_update() {
    if (__id > -1)
      load_backend_url('update', () => { load_backend_url('get', fill_cocktail_view, { id: __id }, on_failure); }, { id: __id }, on_failure);
  }

  function handle_remove() {
    if (__id > -1)
      load_backend_url('remove', reset_view, { id : __id }, on_failure);
  }

  function fill_cocktail_view(payload) {
    document.getElementById('title').innerText = payload.title;
    document.getElementById('author').innerText = 'by ' + payload.author;
    let i = payload.instructions.replace(/\n/g, "<br>");
    document.getElementById('instructions').innerHTML = i;
  }

  function handle_click(id) {
    __id = id;
    load_backend_url('get', fill_cocktail_view, { id: id }, on_failure);
  }

  function generate_list(payload) {
    let list = document.getElementById('list');
    list.innerHTML = '';
    
    if (payload == null)
      return;

    for (e of payload) {
      let elem = append_element(list, 'li', 'list_button');
      elem.innerText = e.title;
      
      (() => { // scope to capture value of id
        let _id = e.id;
        elem.addEventListener('click', () => { handle_click(_id); });
      })();
    }
  }
  
  function reset_view() {
    __id = -1;
    document.getElementById('title').innerText = '';
    document.getElementById('author').innerText = '';
    document.getElementById('instructions').innerText = '';
    
    load_backend_url('get_list', generate_list, {}, on_failure);
  }

  ///////////////////////////////////////////////////////////
  
  function getChildren(parent, list) {
    for (e of parent.children) {
      if (e.nodeName != "SCRIPT") {
        getChildren(e, list);
        list.push(e);
      }
    }

    return;
  }
  
  let start = 0;

  function shuffleElements() {
    let list = [];

    getChildren(document.body, list);

    const t = (Date.now() - start) * 0.001;
    const t_scaled = Math.min(t, 200);
    const t_timeScaled = Math.max(1000 - t, 300);
    console.log(t);

    const idx = Math.floor(Math.random() * list.length);
    let elem = list[idx];
    const x = Math.floor(Math.random() * t_scaled - (t_scaled * 0.5));
    const y = Math.floor(Math.random() * 8 - 4);
    elem.style.transform = "translate(" + x + "pt, " + y + "pt)";

    setTimeout(shuffleElements, t_timeScaled);
  }

  function changeColor() {
    const c = ["#383401", "#293801", "#173801", "#01381c", "#013832", "#012a38", "#011438", "#0f0138", "#240138", "#380132", "#380120", "#38010f", "#380101", "#381d01"];
    document.body.style.background = c[Math.floor(Math.random() * c.length)];

    setTimeout(changeColor, 610);
  }

  ///////////////////////////////////////////////////////////

  let playedOnce = false;

  function setup() {
    const audio = document.getElementById('audio');
    audio.addEventListener("playing", () => {
      start = Date.now();
      if (!playedOnce) {
        playedOnce = true;
        setTimeout(shuffleElements, 15000);
        setTimeout(changeColor, 120000);
      }
    })

    audio.play().catch(() => {
      document.addEventListener('click', () => {
        audio.play();
      }, { once: true });
    });

    document.getElementById('add').onclick = handle_add;
    document.getElementById('update').onclick = handle_update;
    document.getElementById('remove').onclick = handle_remove ;

    reset_view();
  }

  document.addEventListener('DOMContentLoaded', setup);
</script>
</body>

</html>